#!/usr/bin/env bash

set -euo pipefail
current_script_path=${BASH_SOURCE[0]}
plugin_dir=$(dirname "$(dirname "$current_script_path")")

# shellcheck source=../lib/utils.bash
source "${plugin_dir}/lib/utils.bash"


form_url() {
	local version="$1"
	local os=$(get_os)
	local arch=$(get_arch)
	if [ $arch == "none" ]; then
		echo "Architecture not supported by Tea" && exit 1
	fi
	echo "https://gitea.com/gitea/tea/releases/download/v${version}/tea-${version}-${os}-${arch}"
}

install_tea() {
	local version=$2
	local install_path=$3
	local bin_install_path="$install_path"
	local download_url
	download_url="$(form_url "$version")"

	mkdir -p "${bin_install_path}"

	local bin_path="${bin_install_path}/bin/tea"
	echo "Downloading tea from ${download_url} into ${bin_path}"
	if curl -L -sf "$download_url" -o "$bin_path"; then
		mv ${bin_path}/tea-${version}-${get_os}-${get_arch} ${bin_path}/tea
		chmod +x "$bin_path/tea"
	fi
}

install_tea "$ASDF_INSTALL_TYPE" "$ASDF_INSTALL_VERSION" "$ASDF_INSTALL_PATH"
